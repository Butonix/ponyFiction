minimum-vagga: v0.6.1

_templates:
  local_volumes: &local_volumes
    /config: !BindRO /work/config/local
  snippets:
    - &trunk_stuff
      - !Copy
        source: /work/config/trunk
        path: /config
      - !EnsureDir /log
      - !EnsureDir /lithos
      - !Copy
        source: /work/lithos/trunk
        path: /lithos
    - &production_stuff
      - !Copy
        source: /work/config/production
        path: /config
      - !EnsureDir /local
      - !EnsureDir /log
      - !EnsureDir /lithos
      - !Copy
        source: /work/lithos/production
        path: /lithos
    - &host_resolution
      - !EnsureDir /state
      - !Sh |
          /bin/ln -sfn /state/hosts /etc/hosts
          /bin/ln -sfn /state/resolv.conf /etc/resolv.conf

containers:
  _base_alpine:
    setup:
    - !Alpine v3.4
    - !AlpineRepo {branch: edge, repo: main, tag: main}
    - !AlpineRepo {branch: edge, repo: testing, tag: testing}
    - !AlpineRepo {branch: edge, repo: community, tag: community}
    - !EnsureDir /config
    - !Sh "chmod +r /bin/bbsuid"

  redis:
    setup:
    - !Container _base_alpine
    - !Install [redis]
    - !EnsureDir /storage
    volumes:
      <<: *local_volumes
      /storage: !Tmpfs
        size: 128Mi
        mode: 0o1700

  redis-trunk:
    setup:
    - !Container redis
    - !*Unpack
      - *trunk_stuff
      - *host_resolution
    resolv-conf-path: /state/resolv.conf
    hosts-file-path: /state/hosts

  redis-production:
    setup:
    - !Container redis
    - !*Unpack
      - *production_stuff
      - *host_resolution
    resolv-conf-path: /state/resolv.conf
    hosts-file-path: /state/hosts

commands:

  redis-cli: &redis !Command
    container: redis
    description: Run redis CLI
    run: [redis-cli]

  redis: &redis !Command
    container: redis
    description: Run redis server (cache and broker for celery)
    run: redis-server /config/redis.conf

  run: !Supervise
    description: Run full server stack
    kill-unresponsive-after: 5
    children:
      redis: *redis
