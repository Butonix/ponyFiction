{% load static %}
{% load stories %}
{% load pluralize %}
{% load story_comments_delta %}
{% for story in stories %}
	<!-- Вывод рассказа: начало -->
	<div class="story-item" id="story_{{ story.id }}">
		<h3>
			<a href="{% url 'story_view' story.id %}">{{ story.title }}</a> 
			<sup><span class="upvotes">{{ story.vote_up_count }}</span> / <span class="downvotes">{{ story.vote_down_count }}</span></sup>
			{%if not story.finished %}
				<sup class="incomplete">Не закончен</sup>
			{% else %}
				<sup class="complete">Закончен</sup>
			{% endif%}
			{% if story.freezed %}<sup class="suspended">Заморожен</sup>{% endif %}
			{% include 'includes/story_control_buttons.html' %}
		</h3>
		<p class="meta">
			<span class="chapter-controls">
    			{% if user.is_authenticated %}
    				<a title="В избранное" href="{% url 'story_favorite' story.id %}" class="story_favorite scon favorite{% if story|favorited:user.id %} favorited{% endif %}"></a>
        			<a title="Отложить на потом" href="{% url 'story_bookmark' story.id %}" class="story_bookmark scon bookmark{% if story|bookmarked:user.id %} bookmarked{% endif %}"></a>
    			{% endif %} 
        		<a title="Подписаться на новые главы по RSS" href="{% url 'feeds_story' story.id %}" class="scon feed"></a>
        		<a title="Скачать в FB2" href="{% url 'story_fb2' story.id %}" class="get fb2"></a>
        		<a title="Скачать в HTML" href="{% url 'story_html' story.id %}" class="get html"></a>
        		<span class="story_bookmark_msg"></span>
        		<span class="story_favorite_msg"></span>
    		</span>
			{% spaceless %}
				<span class="category-list">
					{% for category in story.categories.all %}
						<a class="gen gen-{{ category.id }}" href="{% url 'search_simple' 'category' category.id %}">{{ category.name }}</a>
					{% endfor %}
				</span>
				{{ story.words|rupluralize:'слово,слова,слов' }} от {% include 'includes/story_authors_list.html' %}
				{% if detailed_view %}
					<p>{% if story.chapter_set.count == 1 %}{{ story.chapter_set.all.0.views|rupluralize:'просмотр,просмотра,просмотров' }}{% endif %}, {{ story.comment_set.count|rupluralize:'комментарий,комментария,комментариев' }}</p>
				{% endif %}
				{% if story|story_comments_delta:user > 0 %}
					(<span class="green">+{{ story|story_comments_delta:user }}</span>)
				{% endif %}
			{% endspaceless %}
		</p>
		<p>{{ story.summary_as_html|striptags }}</p>
		{% if story.chapter_set.count > 1 %}
			<button class="btn btn-collapse btn-small" data-toggle="collapse" data-target="#story-{{ story.id }}">Показать {{ story.chapter_set.count|rupluralize:'главу,главы,глав' }}</button>
		{% endif %}  
		{% if not story.finished or story.finished and story.chapter_set.count > 1 %}
			<div id="story-{{ story.id }}" class="collapse">
				<ul class="chapters-list">
					{% for chapter in story.chapter_set.all %}
						<li>
							<a class="chapter-title" href="{% url 'chapter_view_single' story.id chapter.order %}">{{ chapter.title }}</a> 
							{% if story|is_editable_by:user %}
								<sup><a class="edit-link" href="{% url 'chapter_edit' story.id chapter.id %}">Редактировать</a></sup>
							{% endif %}
							<br/>
							{{ chapter.words|rupluralize:'слово,слова,слов' }}, {{ chapter.views|rupluralize:'просмотр,просмотра,просмотров' }}
						</li>
					{% endfor %}
				</ul>
			</div>
		{% endif %}  
		<p class="meta">
			{% spaceless %}
				<span class="character-list">
					{% for character in story.characters.all %}
						<a href="{% url 'search_simple' 'character' character.id %}"><img src="{% get_static_prefix %}i/characters/{{ character.id }}.png" alt="{{ character.name }}" title="{{ character.name }}"/></a>
					{% endfor %}
				</span>
			{% endspaceless %}
		</p>
	</div>
	<!-- Вывод рассказа: конец -->
{% endfor %}